# PROMPT FOR SIGNAL CONTROLLER AI AGENT

I need to modify the Signal Controller to properly track sent messages so they appear in the conversation with the recipient.

## Current Problem:
- When I send a message via POST `/send` to `+31612345678`, it's stored with MY number as sender
- This creates a separate "Me" conversation instead of appearing in the conversation with `+31612345678`
- I need sent messages to appear in the SAME conversation as received messages from that contact

## Solution: Add recipient tracking and a new query parameter

### 1. Add a `recipient` column to the messages table:
```sql
ALTER TABLE messages ADD COLUMN recipient TEXT;
ALTER TABLE messages ADD COLUMN is_outgoing INTEGER DEFAULT 0;
```

### 2. Modify the `/send` endpoint:
When a message is sent, also store it in the database:
- `sender_number`: MY phone number (Signal Controller's number)
- `sender_name`: "Me" or my contact name
- `recipient`: The "to" parameter (phone number or group_id)
- `message_body`: The sent message text
- `group_id`: Group ID if sending to group, NULL otherwise
- `is_outgoing`: 1 (to mark as outgoing)
- `timestamp`: Current timestamp
- `received_at`: Current datetime

### 3. Add recipient filter to `/messages` endpoint:
Support a new query parameter `recipient` to find messages sent TO someone:
```
GET /messages?recipient=+31612345678
```
This should return messages where `recipient = '+31612345678'` and `is_outgoing = 1`

### 4. Update conversation logic:
When showing a conversation with contact `+31612345678`, the app will:
- Get messages received: `GET /messages?sender=+31612345678`
- Get messages sent: `GET /messages?recipient=+31612345678`
- Merge them client-side

## Example Flow:
1. I send "Hello" to `+31612345678`
2. Database stores:
   - sender_number: `+31681633847` (my number)
   - recipient: `+31612345678`
   - is_outgoing: `1`
   - message_body: "Hello"

3. When viewing chat with `+31612345678`:
   - Fetch received: `/messages?sender=+31612345678`
   - Fetch sent: `/messages?recipient=+31612345678`
   - Both appear in the same conversation

## For Groups:
Group messages work the same way:
- Store with `group_id` set
- Store with `recipient` = group_id
- `is_outgoing` = 1

This way all messages (sent and received) in a group appear together.

Please implement these changes to the Signal Controller.

